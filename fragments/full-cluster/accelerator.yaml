accelerator:
  options:
  - name: fullClusterConfig
    label: "Full Cluster Settings"
    dataType: FullCluster
  types:
    - name: FullCluster
      struct:
        - name: clusterType
          inputType: select
          choices:
            - value: tkgm
              text: TKGm or TKG 2.x with a Management Cluster
            - value: tkgs
              text: TKGs or TKG 2.x with a supervisor
            - value: eks
              text: EKS
            - value: tkgi
              text: TKGi
            - value: other
              text: Other
          required: true
        - name: clusterName
          dataType: string
          label: Cluster Name
          required: true
        - name: supplyChain
          label: Supply Chain
          inputType: select
          defaultValue: "testingScanning"
          choices:
          - value: basic
            text: Basic
          - value: testing
            text: Testing
          - value: testingScanning
            text: Testing and Scanning
        - name: deliveryMethod
          inputType: select
          choices:
            - text: RegOps (Imgpkg)
              value: regOps
            - text: GitOps Direct Commit
              value: direct
            - text: GitOps PR Flow
              value: pull_request
          defaultValue: commit
          label: Deliverable Methodology
        - name: enableSCG
          defaultValue: false
          inputType: checkbox
          dataType: boolean
          label: Include Spring Cloud Gateway Installation
        - name: enableScgPerNamespace
          defaultValue: false
          dependsOn: 
            name: enableSCG
            value: true
          inputType: checkbox
          dataType: boolean
          label: Create Spring Cloud Gateway Per Namespace
        - name: enableESO
          defaultValue: false
          inputType: checkbox
          dataType: boolean
          label: Include External Secrets Operator
        - name: enableAppSSO
          defaultValue: false
          inputType: checkbox
          dataType: boolean
          label: Include AppSSO Auth Server Config
        - name: sourceScanner
          label: Source Scanner
          choices:
            - text: Grype (Default)
              value: grype
            - text: Trivy
              value: trivy
            - text: Prisma
              value: prisma
            - text: Aqua
              value: aqua
          defaultValue: grype
        - name: imageScanner
          label: Image Scanner
          choices:
            - text: Grype (Default)
              value: grype
            - text: Trivy
              value: trivy
            - text: Prisma
              value: prisma
            - text: Aqua
              value: aqua
            - text: Carbon Black
              value: cbc
            - text: Snyk
              value: snyk
          defaultValue: grype
        - name: authProvider
          inputType: select
          choices:
            - text: "Azure AD"
              value: azureAD
            - text: "Okta"
              value: okta
            - text: "Github"
              value: github
            - text: "Gitlab"
              value: gitlab
            - text: "Google"
              value: google
            - text: "None"
              value: none
          defaultValue: none
          label: External IDP for TAP GUI
          required: true
        - name: guestAuth
          defaultValue: false
          inputType: checkbox
          label: Enable Guest Authentication
          dataType: boolean
engine:
  chain:
  - merge:
    - include: [ "**/*" ]
      exclude: ["cluster-template.yaml", "values.yaml"]
    - include: ["values.yaml"]
      chain:
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'github'"
          recipe: org.openrewrite.yaml.DeleteKey
          options:
            keyPath: '"$.tapGui.auth.github"'
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'okta'"
          recipe: org.openrewrite.yaml.DeleteKey
          options:
            keyPath: '"$.tapGui.auth.okta"'
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'gitlab'"
          recipe: org.openrewrite.yaml.DeleteKey
          options:
            keyPath: '"$.tapGui.auth.gitlab"'
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'azureAD'"
          recipe: org.openrewrite.yaml.DeleteKey
          options:
            keyPath: '"$.tapGui.auth.azureAD"'
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'google'"
          recipe: org.openrewrite.yaml.DeleteKey
          options:
            keyPath: '"$.tapGui.auth.google"'  
        - type: OpenRewriteRecipe
          condition: "#fullClusterConfig['authProvider'] != 'none'"
          recipe: org.openrewrite.yaml.ChangeValue
          options:
            oldKeyPath: '"$.tapGui.auth.provider"'
            value: "#fullClusterConfig['authProvider']"
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.yaml.ChangeValue
          options:
            oldKeyPath: '"$.security.sourceScanner"'
            value: "#fullClusterConfig['sourceScanner']"
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.yaml.ChangeValue
          options:
            oldKeyPath: '"$.security.imageScanner"'
            value: "#fullClusterConfig['imageScanner']"

    - include: ["cluster-template.yaml"]
      chain:
      - type: ReplaceText
        substitutions:
        - text: SUPPLY_CHAIN_OF_CHOICE
          with: "#fullClusterConfig['supplyChain']"
        - text: CUSTOMER_NAME
          with: "#artifactId"
      - type: ReplaceText
        condition: "#fullClusterConfig['deliveryMethod'] != 'regOps'"
        substitutions:
        - text: COMMIT_STRATEGY
          with: "#fullClusterConfig['deliveryMethod']"
        - text: GIT_KIND
          with: "#gitType"